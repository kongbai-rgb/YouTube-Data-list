<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI YouTube çƒ­åº¦æ¦œ - ç¾å›½åœ°åŒº</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #ff0000;
            --secondary-color: #282828;
            --background-color: #f9f9f9;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        body {
            background-color: var(--background-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }

        .navbar {
            background-color: white !important;
            box-shadow: var(--card-shadow);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--secondary-color) !important;
        }

        .navbar-brand i {
            color: var(--primary-color);
            margin-right: 0.5rem;
        }

        .action-buttons {
            margin: 2rem 0;
            text-align: center;
        }

        .action-buttons .btn {
            margin: 0 0.5rem;
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            text-align: center;
        }

        .stats-card h3 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }

        .ranking-item {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--card-shadow);
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .ranking-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .rank-number {
            font-size: 1.5rem;
            font-weight: 700;
            width: 60px;
            text-align: center;
            color: #606060;
        }

        .rank-number.top1 { color: #FFD700; }
        .rank-number.top2 { color: #C0C0C0; }
        .rank-number.top3 { color: #CD7F32; }

        .video-thumbnail {
            width: 120px;
            height: 68px;
            object-fit: cover;
            border-radius: 8px;
            margin: 0 1rem;
        }

        .channel-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .channel-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .channel-thumbnail {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 1rem;
        }

        .ai-badge {
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <div id="loadingText">å¤„ç†ä¸­...</div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-youtube"></i>
                AI YouTube çƒ­åº¦æ¦œ
            </a>
            <span class="navbar-text text-muted">
                <i class="bi bi-geo-alt"></i> ç¾å›½åœ°åŒº Â· æ¯æ—¥æ›´æ–°
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="showChannelSearch()">
                <i class="bi bi-search"></i> æœç´¢AIé¢‘é“
            </button>
            <button class="btn btn-success" onclick="fetchVideos()">
                <i class="bi bi-arrow-clockwise"></i> è·å–æœ€æ–°æ•°æ®
            </button>
            <button class="btn btn-info" onclick="showChannelList()">
                <i class="bi bi-list-ul"></i> ç®¡ç†é¢‘é“
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="row" id="statsCards">
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <h3 id="activeChannels">-</h3>
                    <p>æ´»è·ƒé¢‘é“</p>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <h3 id="totalVideos">-</h3>
                    <p>è§†é¢‘æ€»æ•°</p>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <h3 id="todayRankings">-</h3>
                    <p>ä»Šæ—¥ä¸Šæ¦œ</p>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stats-card">
                    <h3 id="apiQuota">-</h3>
                    <p>å‰©ä½™é…é¢</p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#rankingTab" type="button">
                    <i class="bi bi-trophy"></i> çƒ­åº¦æ¦œå•
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#channelSearchTab" type="button">
                    <i class="bi bi-search"></i> é¢‘é“æœç´¢
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#channelManageTab" type="button">
                    <i class="bi bi-gear"></i> é¢‘é“ç®¡ç†
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Ranking Tab -->
            <div class="tab-pane fade show active" id="rankingTab">
                <ul class="nav nav-pills mb-4">
                    <li class="nav-item">
                        <button class="nav-link active" onclick="loadRankings('shorts')">
                            <i class="bi bi-lightning-fill"></i> Shorts çƒ­åº¦æ¦œ
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" onclick="loadRankings('long')">
                            <i class="bi bi-film"></i> é•¿è§†é¢‘çƒ­åº¦æ¦œ
                        </button>
                    </li>
                </ul>
                <div id="rankingList">
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Channel Search Tab -->
            <div class="tab-pane fade" id="channelSearchTab">
                <div class="mb-4">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="æœç´¢AIç›¸å…³é¢‘é“..." value="AI artificial intelligence machine learning">
                        <button class="btn btn-primary" onclick="searchChannels()">
                            <i class="bi bi-search"></i> æœç´¢
                        </button>
                    </div>
                    <small class="text-muted">æç¤ºï¼šé»˜è®¤æœç´¢ç¾å›½åœ°åŒºçš„AIç›¸å…³é¢‘é“</small>
                </div>
                <div id="searchResults"></div>
            </div>

            <!-- Channel Management Tab -->
            <div class="tab-pane fade" id="channelManageTab">
                <h5 class="mb-3">å·²æ·»åŠ çš„é¢‘é“</h5>
                <div id="channelList">
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentRankingType = 'shorts';
        let searchNextPageToken = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadRankings('shorts');
            
            // æ¯åˆ†é’Ÿåˆ·æ–°ç»Ÿè®¡
            setInterval(loadStats, 60000);
        });

        // æ˜¾ç¤º/éšè—åŠ è½½å±‚
        function showLoading(text = 'å¤„ç†ä¸­...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'success') {
            const toastHtml = `
                <div class="toast show" role="alert">
                    <div class="toast-header">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                        <strong class="me-auto">${type === 'success' ? 'æˆåŠŸ' : 'é”™è¯¯'}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;
            
            const toastElement = document.createElement('div');
            toastElement.innerHTML = toastHtml;
            document.getElementById('toastContainer').appendChild(toastElement);
            
            setTimeout(() => {
                toastElement.remove();
            }, 5000);
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('activeChannels').textContent = data.stats.active_channels;
                    document.getElementById('totalVideos').textContent = formatNumber(data.stats.total_videos);
                    document.getElementById('todayRankings').textContent = data.stats.today_rankings;
                    document.getElementById('apiQuota').textContent = formatNumber(data.stats.api_quota_remaining);
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // æœç´¢é¢‘é“
        async function searchChannels() {
            const searchInput = document.getElementById('searchInput').value;
            if (!searchInput) {
                showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error');
                return;
            }

            showLoading('æœç´¢é¢‘é“ä¸­...');
            
            try {
                const response = await fetch(`/api/search/channels?q=${encodeURIComponent(searchInput)}`);
                const data = await response.json();
                
                hideLoading();
                
                if (data.success) {
                    displaySearchResults(data.channels);
                    searchNextPageToken = data.nextPageToken;
                    showToast(`æ‰¾åˆ° ${data.channels.length} ä¸ªé¢‘é“ï¼Œå‰©ä½™é…é¢: ${data.quotaRemaining}`);
                } else {
                    showToast(data.error || 'æœç´¢å¤±è´¥', 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('æœç´¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(channels) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (channels.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-info">æœªæ‰¾åˆ°ç›¸å…³é¢‘é“</div>';
                return;
            }

            let html = '<div class="list-group">';
            channels.forEach(channel => {
                html += `
                    <div class="channel-item">
                        <div class="channel-info">
                            <img src="${channel.thumbnails.default.url}" class="channel-thumbnail" alt="${channel.name}">
                            <div>
                                <h6 class="mb-0">${channel.name}</h6>
                                <small class="text-muted">${channel.description.substring(0, 100)}...</small>
                            </div>
                            ${channel.isAIRelated ? '<span class="ai-badge">AIç›¸å…³</span>' : ''}
                        </div>
                        <div>
                            ${channel.isAdded 
                                ? '<button class="btn btn-sm btn-secondary" disabled>å·²æ·»åŠ </button>'
                                : `<button class="btn btn-sm btn-success" onclick="addChannel('${channel.id}', '${channel.name.replace(/'/g, "\\'")}')">
                                    <i class="bi bi-plus"></i> æ·»åŠ 
                                   </button>`
                            }
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            if (searchNextPageToken) {
                html += `
                    <div class="text-center mt-3">
                        <button class="btn btn-primary" onclick="loadMoreSearchResults()">
                            åŠ è½½æ›´å¤š
                        </button>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }

        // æ·»åŠ é¢‘é“
        async function addChannel(channelId, channelName) {
            try {
                const response = await fetch('/api/channels/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        channelId: channelId,
                        channelName: channelName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`æˆåŠŸæ·»åŠ é¢‘é“: ${channelName}`);
                    // åˆ·æ–°æœç´¢ç»“æœ
                    searchChannels();
                    // åˆ·æ–°ç»Ÿè®¡
                    loadStats();
                } else {
                    showToast(data.error || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è·å–è§†é¢‘æ•°æ®
        async function fetchVideos() {
            if (!confirm('è¿™å°†æ¶ˆè€—å¤§é‡APIé…é¢ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }

            showLoading('æ­£åœ¨è·å–è§†é¢‘æ•°æ®ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ...');
            
            try {
                const response = await fetch('/api/fetch/videos', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                hideLoading();
                
                if (data.success) {
                    showToast(data.message);
                    // åˆ·æ–°ç»Ÿè®¡å’Œæ¦œå•
                    loadStats();
                    loadRankings(currentRankingType);
                } else {
                    showToast(data.error || 'è·å–å¤±è´¥', 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('è·å–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½æ¦œå•
        async function loadRankings(type) {
            currentRankingType = type;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.nav-pills .nav-link').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            const listDiv = document.getElementById('rankingList');
            listDiv.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div></div>';

            try {
                const response = await fetch(`/api/rankings/${type}`);
                const data = await response.json();
                
                if (data.success && data.rankings.length > 0) {
                    displayRankings(data.rankings, type);
                } else {
                    listDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> æš‚æ— æ¦œå•æ•°æ®
                            <br><small>è¯·å…ˆç‚¹å‡»"è·å–æœ€æ–°æ•°æ®"æŒ‰é’®è·å–è§†é¢‘ä¿¡æ¯</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½æ¦œå•å¤±è´¥:', error);
                listDiv.innerHTML = '<div class="alert alert-danger">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }

        // æ˜¾ç¤ºæ¦œå•
        function displayRankings(rankings, type) {
            const listDiv = document.getElementById('rankingList');
            
            let html = '';
            rankings.forEach((item, index) => {
                const rank = index + 1;
                const rankClass = rank === 1 ? 'top1' : rank === 2 ? 'top2' : rank === 3 ? 'top3' : '';
                
                html += `
                    <div class="ranking-item">
                        <div class="rank-number ${rankClass}">
                            ${rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '#' + rank}
                        </div>
                        <img src="${item.thumbnail}" class="video-thumbnail" 
                             alt="${item.title}"
                             onerror="this.src='https://via.placeholder.com/120x68?text=No+Image'">
                        <div class="video-info flex-grow-1">
                            <h6 class="mb-1">
                                <a href="https://youtube.com/watch?v=${item.video_id}" 
                                   target="_blank" class="text-decoration-none text-dark">
                                    ${item.title}
                                </a>
                            </h6>
                            <div class="text-muted small">
                                <i class="bi bi-person"></i> ${item.channel_name} | 
                                <i class="bi bi-eye"></i> ${formatNumber(item.view_count)} | 
                                <i class="bi bi-hand-thumbs-up"></i> ${formatNumber(item.like_count)} | 
                                <i class="bi bi-chat"></i> ${formatNumber(item.comment_count)}
                                ${type === 'long' ? ` | <i class="bi bi-clock"></i> ${formatDuration(item.duration)}` : ''}
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success">+${formatNumber(item.view_increment)}</span>
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        // æ˜¾ç¤ºé¢‘é“æœç´¢æ ‡ç­¾
        function showChannelSearch() {
            const searchTab = document.querySelector('[data-bs-target="#channelSearchTab"]');
            const tab = new bootstrap.Tab(searchTab);
            tab.show();
        }

        // æ˜¾ç¤ºé¢‘é“åˆ—è¡¨
        async function showChannelList() {
            const manageTab = document.querySelector('[data-bs-target="#channelManageTab"]');
            const tab = new bootstrap.Tab(manageTab);
            tab.show();
            
            // åŠ è½½é¢‘é“åˆ—è¡¨
            try {
                const response = await fetch('/api/channels');
                const data = await response.json();
                
                if (data.success) {
                    displayChannelList(data.channels);
                }
            } catch (error) {
                console.error('åŠ è½½é¢‘é“åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºé¢‘é“åˆ—è¡¨
        function displayChannelList(channels) {
            const listDiv = document.getElementById('channelList');
            
            if (channels.length === 0) {
                listDiv.innerHTML = '<div class="alert alert-info">è¿˜æœªæ·»åŠ ä»»ä½•é¢‘é“</div>';
                return;
            }

            let html = '<div class="list-group">';
            channels.forEach(channel => {
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">${channel.name}</h6>
                            <small class="text-muted">ID: ${channel.id}</small>
                        </div>
                        <span class="badge bg-primary">${channel.video_count || 0} ä¸ªè§†é¢‘</span>
                    </div>
                `;
            });
            html += '</div>';
            
            listDiv.innerHTML = html;
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>